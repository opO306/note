import{r as l,d as N,f as Y,j as e}from"./index-Dk92xA2w.js";import{M as X,N as Z,O as ee,P as te,W as se,Q as re,A as C,K as ae,J as ne,z as O}from"./vendor-firebase-C8ERkm_B.js";import{g as A,B as T}from"./App-Bs6YIlvy.js";import{C as I,b as U,c as D,a as R}from"./card-BTNeCppV.js";import{A as ie}from"./alert-dialog-simple-CJo3HBbI.js";import{A as le}from"./AppHeader-B4u7aGdb.js";import"./vendor-capacitor-rvH5hiNU.js";import"./vendor-react-1wgkHQEd.js";import"./checkbox-BNqRj2KP.js";import"./index-DKlU3y7i.js";import"./index-SzzsopSI.js";import"./check-CFbpOADo.js";import"./arrow-left-BKP0x_yl.js";function Ne({onBack:G}){const[j,H]=l.useState([]),[b,k]=l.useState(null),[L]=l.useState(null),[J]=l.useState(null),[P,_]=l.useState(!1),[B,w]=l.useState(null),[c,K]=l.useState(null),[m,h]=l.useState(null),[f,x]=l.useState(null),[E,p]=l.useState(""),[$,q]=l.useState(!1),[g,S]=l.useState(null),a=l.useMemo(()=>j.find(s=>s.id===b)??null,[j,b]);l.useEffect(()=>{const s=X(N,"reports"),i=Z(s,se("status","in",["pending","needs_review"]),te("createdAt","desc"),ee(50)),d=re(i,o=>{const u=o.docs.map(r=>{const n=r.data();return{id:r.id,targetType:n.targetType==="reply"?"reply":"post",targetId:String(n.targetId??""),targetAuthorUid:typeof n.targetAuthorUid=="string"?n.targetAuthorUid:null,reporterUid:typeof n.reporterUid=="string"?n.reporterUid:null,reasons:Array.isArray(n.reasons)?n.reasons:[],details:typeof n.details=="string"&&n.details.length>0?n.details:null,createdAt:n.createdAt??null,status:n.status==="needs_review"||n.status==="confirmed"||n.status==="rejected"?n.status:"pending",priority:n.priority==="high"?"high":"normal",postId:typeof n.postId=="string"&&n.postId.length>0?n.postId:null}}).sort((r,n)=>r.priority==="high"&&n.priority!=="high"?-1:r.priority!=="high"&&n.priority==="high"?1:0);H(u),k(r=>r&&!u.some(n=>n.id===r)?null:r)},o=>{});return()=>{d()}},[]),l.useEffect(()=>{let s=!1;return(async()=>{if(!a){if(s)return;h(null),x(null),p("");return}try{if(a.targetType==="post"){const d=C(N,"posts",a.targetId),o=await O(d);if(s)return;if(!o.exists()){h(null),x(null),p("");return}const t=o.data(),u=t.createdAt&&typeof t.createdAt.toDate=="function"?t.createdAt.toDate():new Date,r={id:o.id,title:t.title??"",content:t.content??"",category:t.category??"기타",subCategory:t.subCategory??"전체",type:t.type??"question",tags:Array.isArray(t.tags)?t.tags:[],author:t.author??"알 수 없음",authorUid:typeof t.authorUid=="string"?t.authorUid:null,authorAvatar:t.authorAvatar??"",createdAt:u,lanterns:typeof t.lanterns=="number"?t.lanterns:0,replies:Array.isArray(t.replies)?t.replies:[],replyCount:typeof t.replyCount=="number"?t.replyCount:Array.isArray(t.replies)?t.replies.length:0,comments:typeof t.comments=="number"?t.comments:Array.isArray(t.replies)?t.replies.length:0,views:typeof t.views=="number"?t.views:0,isBookmarked:!1,isOwner:!1,authorTitleId:t.authorTitleId??null,authorTitleName:t.authorTitleName??null,hidden:t.hidden===!0,reportCount:typeof t.reportCount=="number"?t.reportCount:void 0};if(s)return;h(r),x(null),p(r.author)}else{if(!a.postId){if(s)return;h(null),x(null),p("");return}const d=C(N,"posts",a.postId),o=await O(d);if(s)return;if(!o.exists()){h(null),x(null),p("");return}const t=o.data(),u=Array.isArray(t.replies)?t.replies:[],r=u.find(v=>String(v.id??"")===a.targetId)??null;if(s)return;const n=t.createdAt&&typeof t.createdAt.toDate=="function"?t.createdAt.toDate():new Date,W={id:o.id,title:t.title??"",content:t.content??"",category:t.category??"기타",subCategory:t.subCategory??"전체",type:t.type??"question",tags:Array.isArray(t.tags)?t.tags:[],author:t.author??"알 수 없음",authorUid:typeof t.authorUid=="string"?t.authorUid:null,authorAvatar:t.authorAvatar??"",createdAt:n,lanterns:typeof t.lanterns=="number"?t.lanterns:0,replies:u,replyCount:typeof t.replyCount=="number"?t.replyCount:u.length,comments:typeof t.comments=="number"?t.comments:u.length,views:typeof t.views=="number"?t.views:0,isBookmarked:!1,isOwner:!1,authorTitleId:t.authorTitleId??null,authorTitleName:t.authorTitleName??null,hidden:t.hidden===!0,reportCount:typeof t.reportCount=="number"?t.reportCount:void 0};if(s)return;if(h(W),!r){x(null),p("");return}let y;if(r.createdAt&&typeof r.createdAt.toDate=="function")y=r.createdAt.toDate();else if(r.createdAt instanceof Date)y=r.createdAt;else if(typeof r.createdAt=="string"||typeof r.createdAt=="number"){const v=new Date(r.createdAt);y=Number.isNaN(v.getTime())?new Date:v}else y=new Date;const F={id:typeof r.id=="number"||typeof r.id=="string"?r.id:a.targetId,content:r.content??"",author:r.author??"알 수 없음",authorUid:typeof r.authorUid=="string"?r.authorUid:null,authorAvatar:typeof r.authorAvatar=="string"?r.authorAvatar:"",timeAgo:r.timeAgo??"",lanterns:typeof r.lanterns=="number"?r.lanterns:0,isGuide:!!r.isGuide,createdAt:y,authorTitleId:r.authorTitleId??null};if(s)return;x(F),p(F.author)}}catch{if(s)return;h(null),x(null),p("")}})(),()=>{s=!0}},[a]);const M=l.useCallback((s,i)=>{S({reportId:s,nextStatus:i})},[]),Q=l.useCallback(async()=>{if(!g)return;const{reportId:s,nextStatus:i}=g;q(!0);try{const d=C(N,"reports",s);await ae(d,{status:i})}catch{}finally{q(!1),S(null)}},[g]),V=l.useCallback(async()=>{if(!a)return;const s=a.targetType==="post",i=s?m?.content??"":f?.content??"";if(!i){w("검수할 본문이 없습니다.");return}_(!0),w(null);try{const d=ne(Y,"aiModerationReview"),{data:o}=await d({targetType:a.targetType,title:s?m?.title??"":"",content:i,reasons:a.reasons,details:a.details,reporterUid:a.reporterUid??null,targetAuthorUid:a.targetAuthorUid??null});K(o)}catch(d){w(d?.message??"AI 검수 요청에 실패했습니다.")}finally{_(!1)}},[a,m,f]),z=s=>{if(!s||typeof s.toDate!="function")return"";const i=s.toDate(),d=i.getFullYear(),o=String(i.getMonth()+1).padStart(2,"0"),t=String(i.getDate()).padStart(2,"0"),u=String(i.getHours()).padStart(2,"0"),r=String(i.getMinutes()).padStart(2,"0");return`${d}-${o}-${t} ${u}:${r}`};return e.jsxs("div",{className:"w-full flex-1 min-h-0 bg-background text-foreground flex flex-col",children:[e.jsx(le,{title:"신고 관리",onBack:G}),e.jsxs("div",{className:"flex-1 min-h-0 flex flex-col md:flex-row border-t border-border",children:[e.jsx("div",{className:"flex-1 min-h-0 md:w-1/2 border-b md:border-b-0 md:border-r border-border overflow-y-auto",children:j.length===0?e.jsx("div",{className:"p-4 text-sm text-muted-foreground",children:"처리할 신고가 없습니다."}):j.map(s=>e.jsxs("button",{type:"button",onClick:()=>k(s.id),className:`w-full text-left px-4 py-3 border-b border-border hover:bg-accent/20 ${b===s.id?"bg-accent/30":"bg-background"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsxs("div",{className:"text-xs text-muted-foreground",children:[s.targetType==="post"?"게시글":"댓글"," 신고"]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[s.priority==="high"&&e.jsx(A,{variant:"destructive",className:"text-[10px]",children:"우선 검토"}),e.jsxs(A,{variant:s.status==="pending"?"outline":s.status==="needs_review"?"secondary":s.status==="confirmed"?"default":"outline",className:"text-[10px]",children:[s.status==="pending"&&"대기",s.status==="needs_review"&&"검토 필요",s.status==="confirmed"&&"확정",s.status==="rejected"&&"거절"]})]})]}),e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:z(s.createdAt)}),e.jsx("div",{className:"text-sm font-medium truncate",children:s.reasons&&s.reasons.length>0?s.reasons[0]:"사유 없음"}),s.details&&e.jsx("div",{className:"text-xs text-muted-foreground line-clamp-2 mt-1",children:s.details})]},s.id))}),e.jsx("div",{className:"flex-1 min-h-0 md:w-1/2 overflow-y-auto",children:a?e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs(I,{children:[e.jsx(U,{children:e.jsx(D,{className:"text-sm",children:"신고 정보"})}),e.jsxs(R,{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"대상"}),e.jsx("span",{children:a.targetType==="post"?"게시글":"댓글"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"신고 상태"}),e.jsx("span",{children:a.status})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"우선순위"}),e.jsx("span",{children:a.priority==="high"?"높음":"보통"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground mb-1",children:"신고 사유"}),e.jsx("ul",{className:"list-disc list-inside space-y-1",children:a.reasons&&a.reasons.length>0?a.reasons.map((s,i)=>e.jsx("li",{children:s},i)):e.jsx("li",{className:"text-muted-foreground",children:"사유가 없습니다."})})]}),a.details&&e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground mb-1",children:"상세 설명"}),e.jsx("div",{className:"whitespace-pre-wrap",children:a.details})]}),e.jsxs("div",{className:"text-xs text-muted-foreground mt-2",children:["생성일시: ",z(a.createdAt)]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"작성자 신뢰도"}),e.jsx("span",{children:L??"알 수 없음"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"신고자 신뢰도"}),e.jsx("span",{children:J??"알 수 없음"})]})]})]}),e.jsxs(I,{children:[e.jsx(U,{children:e.jsx(D,{className:"text-sm",children:"대상 콘텐츠"})}),e.jsxs(R,{className:"space-y-2 text-sm",children:[a.targetType==="post"&&m&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"font-semibold",children:m.title}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["작성자: ",E||m.author]}),e.jsx("div",{className:"mt-2 whitespace-pre-wrap",children:String(m.content??"")})]}),a.targetType==="reply"&&f&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-xs text-muted-foreground",children:["댓글 작성자:"," ",E||f.author]}),e.jsx("div",{className:"mt-2 whitespace-pre-wrap",children:String(f.content??"")}),m&&e.jsxs("div",{className:"mt-4 p-3 rounded-md bg-muted/40 text-xs",children:[e.jsx("div",{className:"font-semibold mb-1",children:"원문 게시글"}),e.jsx("div",{className:"text-xs text-muted-foreground",children:m.title})]})]}),!m&&!f&&e.jsx("div",{className:"text-xs text-muted-foreground",children:"대상 글/댓글을 찾을 수 없습니다. (이미 삭제되었을 수 있습니다)"})]})]}),e.jsxs(I,{children:[e.jsxs(U,{className:"flex flex-row items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(D,{className:"text-sm",children:"AI 검수 보조"}),e.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:"운영자 전용 · Vertex AI Gemini 사용"})]}),e.jsx(T,{size:"sm",onClick:V,disabled:P||!a,children:P?"검수 중...":"AI 요약/권고"})]}),e.jsxs(R,{className:"space-y-3 text-sm",children:[B&&e.jsx("div",{className:"text-destructive text-xs",children:B}),c?e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground text-xs",children:"요약"}),e.jsx("div",{className:"mt-1 whitespace-pre-wrap",children:c.summary})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground text-xs",children:"권고"}),e.jsxs(A,{variant:c.recommendation==="reject"?"secondary":c.recommendation==="action_needed"?"destructive":"outline",children:[c.recommendation==="reject"&&"무효/거절 권고",c.recommendation==="needs_review"&&"추가 검토 필요",c.recommendation==="action_needed"&&"조치 필요"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground text-xs",children:"위험 점수"}),e.jsxs("span",{children:[(c.riskScore*100).toFixed(0),"%"]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground text-xs",children:"근거"}),e.jsx("div",{className:"mt-1 whitespace-pre-wrap",children:c.rationale})]}),c.flags&&c.flags.length>0&&e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground text-xs",children:"감지 플래그"}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-1",children:c.flags.map((s,i)=>e.jsx(A,{variant:"outline",children:s},i))})]})]}):e.jsx("div",{className:"text-muted-foreground text-xs",children:"신고된 본문을 바탕으로 요약과 조치 권고를 받아볼 수 있습니다."})]})]}),e.jsxs("div",{className:"flex items-center justify-end space-x-2",children:[e.jsx(T,{variant:"outline",size:"sm",disabled:$,onClick:()=>M(a.id,"rejected"),children:"문제 없음"}),e.jsx(T,{variant:"default",size:"sm",disabled:$,onClick:()=>M(a.id,"confirmed"),children:"문제 있음"})]})]}):e.jsx("div",{className:"p-4 text-sm text-muted-foreground",children:"왼쪽에서 신고를 선택하면 상세 내용이 표시됩니다."})})]}),e.jsx(ie,{open:!!g,onOpenChange:s=>{s||S(null)},title:"신고 처리",description:g?.nextStatus==="confirmed"?"이 신고를 '문제 있음'으로 처리할까요? 해당 글(또는 댓글)은 사용자 화면에서 숨겨집니다.":"이 신고를 '문제 없음'으로 처리할까요?",confirmText:"확인",onConfirm:Q})]})}export{Ne as AdminReportScreen};
