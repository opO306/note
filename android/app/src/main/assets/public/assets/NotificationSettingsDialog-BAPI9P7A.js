import{r,a as C,d as D,j as e}from"./index-BbQUyxS2.js";import{d as L,B as A}from"./App-CSSMO0Oh.js";import{S as U}from"./switch-BSamu2IM.js";import{S as X}from"./separator-C6JmnAH4.js";import{t as f}from"./toastHelper-C2J_DWXH.js";import{x as z,M,w as Y,K as Z}from"./vendor-firebase-C-5pmDAC.js";import{A as H}from"./AppHeader-CEmD3kaq.js";import{e as J,B as O}from"./MainScreenRefactored-BV6t3nIm.js";import"./vendor-capacitor-B-BXHHKA.js";import"./vendor-react-1wgkHQEd.js";import"./index-5LAPAtmD.js";import"./index-3nZT1wFB.js";import"./arrow-left-2FIjscO0.js";import"./card-3DnD1VWg.js";import"./checkbox-CPLuEh_8.js";import"./check-C_WT1q55.js";import"./avatar-CLeAy6nm.js";import"./alert-dialog-simple-C_DV6hbj.js";import"./sparkles-Bmu-kJOd.js";import"./firebaseCache-C_csZa1c.js";import"./profanityFilter-CmEWjjlv.js";import"./users-BnxKf8TP.js";import"./sun-ay515dC2.js";const v={getItem:m=>{try{return typeof window>"u"?null:localStorage.getItem(m)}catch{return null}},setItem:(m,l)=>{try{if(typeof window>"u")return;localStorage.setItem(m,l)}catch{}}};function Ce({onBack:m,categories:l}){const[x,o]=r.useState(new Set),[i,p]=r.useState(!0),[B,I]=r.useState(!1),j=r.useRef(null),T=r.useRef(null),h=r.useCallback((t,a,s)=>{const n=s??C.currentUser?.uid;if(!n)return;const u=Array.from(t);v.setItem(`notificationSettings:${n}`,JSON.stringify(u)),v.setItem(`allNotificationsEnabled:${n}`,a.toString())},[]),c=r.useCallback((t,a)=>{const s=C.currentUser?.uid??null;if(h(t,a,s),!s)return;const n=z(D,"users",s),u={allEnabled:a,enabledCategories:Array.from(t)};T.current=u,j.current&&window.clearTimeout(j.current),j.current=window.setTimeout(async()=>{const w=T.current;if(w)try{await M(n,{notificationSettings:w})}catch{f.error("알림 설정을 저장하지 못했어요. 잠시 후 다시 시도해주세요.")}},400)},[h]);r.useEffect(()=>()=>{j.current&&window.clearTimeout(j.current)},[]),r.useEffect(()=>{const t=l.map(d=>d.id),a=C.currentUser?.uid;let s=new Set(t),n=!0;const u=a?v.getItem(`notificationSettings:${a}`):null,w=a?v.getItem(`allNotificationsEnabled:${a}`):null;if(u)try{const d=JSON.parse(u);Array.isArray(d)&&(s=new Set(d.filter(S=>t.includes(S))))}catch{}w!==null&&(n=w==="true");const N=C.currentUser?.uid;if(!N){o(s),p(n),I(!0);return}let b=!1;const E=z(D,"users",N);return(async()=>{try{const d=await Y(E);if(d.exists()){const g=d.data().notificationSettings;if(g&&typeof g=="object"){const y=typeof g.allEnabled=="boolean"?g.allEnabled:n,k=(Array.isArray(g.enabledCategories)?g.enabledCategories:Array.from(s)).filter(W=>t.includes(W)),$=new Set(y?k.length>0?k:t:k);b||(o($),p(y),h($,y,N))}else{b||(o(s),p(n),h(s,n,N));const y={allEnabled:n,enabledCategories:Array.from(s)};await M(E,{notificationSettings:y})}}else{b||(o(s),p(n),h(s,n));const S={allEnabled:n,enabledCategories:Array.from(s)};await Z(E,{notificationSettings:S},{merge:!0})}}catch{f.error("알림 설정을 불러오지 못했어요. 기본 설정을 사용합니다."),b||(o(s),p(n))}finally{b||I(!0)}})(),()=>{b=!0}},[l,h]);const R=r.useCallback(t=>{const a=new Set(x),s=a.has(t);s?a.delete(t):a.add(t),o(a),c(a,i);const n=l.find(u=>u.id===t)?.name;f.success(s?`${n} 알림이 비활성화되었습니다`:`${n} 알림이 활성화되었습니다`)},[x,l,i,c]),K=r.useCallback(t=>()=>{R(t)},[R]),P=r.useCallback(t=>{if(p(t),t){const a=l.map(n=>n.id),s=new Set(a);o(s),c(s,!0),f.success("모든 알림이 활성화되었습니다")}else{const a=new Set;o(a),c(a,!1),f.success("모든 알림이 비활성화되었습니다")}},[l,c]),_=r.useCallback(()=>{const t=l.map(s=>s.id),a=new Set(t);o(a),c(a,i),f.success("모든 카테고리 알림이 활성화되었습니다")},[l,i,c]),q=r.useCallback(()=>{const t=new Set;o(t),c(t,i),f.success("모든 카테고리 알림이 비활성화되었습니다")},[i,c]),F=r.useCallback(()=>{m()},[m]),G=r.useCallback(t=>e.jsx(t,{className:"w-4 h-4"}),[]),Q=r.useMemo(()=>l.filter(t=>t.id!=="전체"),[l]),V=r.useMemo(()=>x.size,[x]);return B?e.jsxs("div",{className:"w-full h-full bg-background text-foreground flex flex-col",children:[e.jsx(H,{title:"알림 설정",icon:e.jsx(J,{className:"w-5 h-5"}),onBack:m}),e.jsxs("div",{className:"flex-1 min-h-0 overflow-y-auto p-4 space-y-6 pb-24 safe-bottom",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(O,{className:"w-4 h-4 text-primary"}),e.jsx("span",{className:"font-medium",children:"전체 알림"})]}),e.jsx(U,{checked:i,onCheckedChange:P})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"모든 알림을 일괄적으로 켜거나 끌 수 있습니다"})]}),e.jsx(X,{}),e.jsxs("div",{className:L("space-y-4",!i&&"opacity-60"),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"font-medium",children:"카테고리별 알림"}),i&&e.jsxs("div",{className:"space-x-2",children:[e.jsx(A,{variant:"outline",size:"sm",onClick:_,className:"touch-target px-3 text-xs",children:"전체 선택"}),e.jsx(A,{variant:"outline",size:"sm",onClick:q,className:"touch-target px-3 text-xs",children:"전체 해제"})]})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:i?"관심 있는 카테고리만 선택하여 알림을 받을 수 있습니다":"전체 알림을 활성화하면 카테고리별 알림 설정을 변경할 수 있습니다"}),e.jsx("div",{className:"space-y-3",children:Q.map(t=>e.jsxs("div",{className:L("flex items-center justify-between p-3 border border-border rounded-lg",!i&&"pointer-events-none"),children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[G(t.icon),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:t.name}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[t.count,"개 게시글"]})]})]}),e.jsx(U,{checked:x.has(t.id),onCheckedChange:K(t.id),disabled:!i})]},t.id))}),i&&e.jsx("div",{className:"mt-4 p-3 bg-muted/50 rounded-lg",children:e.jsxs("div",{className:"flex items-center space-x-2 text-sm",children:[e.jsx(O,{className:"w-4 h-4"}),e.jsxs("span",{children:["현재"," ",e.jsxs("span",{className:"font-medium text-primary",children:[V,"개 카테고리"]}),"의 알림을 받고 있습니다"]})]})})]})]}),e.jsx("div",{className:"bg-background/95 backdrop-blur-xl border-t border-border p-4 safe-nav-bottom flex-shrink-0",children:e.jsx(A,{onClick:F,className:"w-full",children:"완료"})})]}):e.jsxs("div",{className:"w-full h-full bg-background text-foreground flex flex-col",children:[e.jsx(H,{title:"알림 설정",icon:e.jsx(J,{className:"w-5 h-5"}),onBack:m}),e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsx("span",{className:"text-sm text-muted-foreground",children:"알림 설정을 불러오는 중..."})})]})}export{Ce as NotificationSettingsDialog};
