import{r,b as C,d as D,j as e}from"./index-BJjkZhAE.js";import{s as f,F as L,G as U,H as z,B as A}from"./App-Cnx-z95_.js";import{S as H}from"./switch-BKazc2QQ.js";import{S as W}from"./separator-DCfBlNin.js";import{Y as J,$ as M,a2 as X,a3 as Z}from"./vendor-firebase-B8qz7irO.js";import{A as O}from"./AppHeader-DUFlu2QS.js";import"./vendor-capacitor-Bm7NWSxP.js";import"./vendor-react-1wgkHQEd.js";const v={getItem:u=>{try{return typeof window>"u"?null:localStorage.getItem(u)}catch{return null}},setItem:(u,l)=>{try{if(typeof window>"u")return;localStorage.setItem(u,l)}catch{}}};function oe({onBack:u,categories:l}){const[x,c]=r.useState(new Set),[i,h]=r.useState(!0),[F,I]=r.useState(!1),j=r.useRef(null),T=r.useRef(null),p=r.useCallback((t,a,s)=>{const n=s??C.currentUser?.uid??"guest",m=Array.from(t);v.setItem(`notificationSettings:${n}`,JSON.stringify(m)),v.setItem(`allNotificationsEnabled:${n}`,a.toString())},[]),o=r.useCallback((t,a)=>{const s=C.currentUser?.uid??null;if(p(t,a,s),!s)return;const n=J(D,"users",s),m={allEnabled:a,enabledCategories:Array.from(t)};T.current=m,j.current&&window.clearTimeout(j.current),j.current=window.setTimeout(async()=>{const w=T.current;if(w)try{await M(n,{notificationSettings:w})}catch{f.error("알림 설정을 저장하지 못했어요. 잠시 후 다시 시도해주세요.")}},400)},[p]);r.useEffect(()=>()=>{j.current&&window.clearTimeout(j.current)},[]),r.useEffect(()=>{const t=l.map(d=>d.id),a=C.currentUser?.uid??"guest";let s=new Set(t),n=!0;const m=v.getItem(`notificationSettings:${a}`),w=v.getItem(`allNotificationsEnabled:${a}`);if(m)try{const d=JSON.parse(m);Array.isArray(d)&&(s=new Set(d.filter(S=>t.includes(S))))}catch{}w!==null&&(n=w==="true");const N=C.currentUser?.uid;if(!N){c(s),h(n),I(!0);return}let b=!1;const E=J(D,"users",N);return(async()=>{try{const d=await X(E);if(d.exists()){const g=d.data().notificationSettings;if(g&&typeof g=="object"){const y=typeof g.allEnabled=="boolean"?g.allEnabled:n,k=(Array.isArray(g.enabledCategories)?g.enabledCategories:Array.from(s)).filter(V=>t.includes(V)),$=new Set(y?k.length>0?k:t:k);b||(c($),h(y),p($,y,N))}else{b||(c(s),h(n),p(s,n,N));const y={allEnabled:n,enabledCategories:Array.from(s)};await M(E,{notificationSettings:y})}}else{b||(c(s),h(n),p(s,n));const S={allEnabled:n,enabledCategories:Array.from(s)};await Z(E,{notificationSettings:S},{merge:!0})}}catch{f.error("알림 설정을 불러오지 못했어요. 기본 설정을 사용합니다."),b||(c(s),h(n))}finally{b||I(!0)}})(),()=>{b=!0}},[l,p]);const R=r.useCallback(t=>{const a=new Set(x),s=a.has(t);s?a.delete(t):a.add(t),c(a),o(a,i);const n=l.find(m=>m.id===t)?.name;f.success(s?`${n} 알림이 비활성화되었습니다`:`${n} 알림이 활성화되었습니다`)},[x,l,i,o]),G=r.useCallback(t=>()=>{R(t)},[R]),P=r.useCallback(t=>{if(h(t),t){const a=l.map(n=>n.id),s=new Set(a);c(s),o(s,!0),f.success("모든 알림이 활성화되었습니다")}else{const a=new Set;c(a),o(a,!1),f.success("모든 알림이 비활성화되었습니다")}},[l,o]),Y=r.useCallback(()=>{const t=l.map(s=>s.id),a=new Set(t);c(a),o(a,i),f.success("모든 카테고리 알림이 활성화되었습니다")},[l,i,o]),_=r.useCallback(()=>{const t=new Set;c(t),o(t,i),f.success("모든 카테고리 알림이 비활성화되었습니다")},[i,o]),q=r.useCallback(()=>{u()},[u]),B=r.useCallback(t=>e.jsx(t,{className:"w-4 h-4"}),[]),K=r.useMemo(()=>l.filter(t=>t.id!=="전체"),[l]),Q=r.useMemo(()=>x.size,[x]);return F?e.jsxs("div",{className:"w-full h-full bg-background text-foreground flex flex-col",children:[e.jsx(O,{title:"알림 설정",icon:e.jsx(L,{className:"w-5 h-5"}),onBack:u}),e.jsxs("div",{className:"flex-1 min-h-0 overflow-y-auto p-4 space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(U,{className:"w-4 h-4 text-primary"}),e.jsx("span",{className:"font-medium",children:"전체 알림"})]}),e.jsx(H,{checked:i,onCheckedChange:P})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"모든 알림을 일괄적으로 켜거나 끌 수 있습니다"})]}),e.jsx(W,{}),e.jsxs("div",{className:z("space-y-4",!i&&"opacity-60"),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"font-medium",children:"카테고리별 알림"}),i&&e.jsxs("div",{className:"space-x-2",children:[e.jsx(A,{variant:"outline",size:"sm",onClick:Y,className:"touch-target px-3 text-xs",children:"전체 선택"}),e.jsx(A,{variant:"outline",size:"sm",onClick:_,className:"touch-target px-3 text-xs",children:"전체 해제"})]})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:i?"관심 있는 카테고리만 선택하여 알림을 받을 수 있습니다":"전체 알림을 활성화하면 카테고리별 알림 설정을 변경할 수 있습니다"}),e.jsx("div",{className:"space-y-3",children:K.map(t=>e.jsxs("div",{className:z("flex items-center justify-between p-3 border border-border rounded-lg",!i&&"pointer-events-none"),children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[B(t.icon),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:t.name}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[t.count,"개 게시글"]})]})]}),e.jsx(H,{checked:x.has(t.id),onCheckedChange:G(t.id),disabled:!i})]},t.id))}),i&&e.jsx("div",{className:"mt-4 p-3 bg-muted/50 rounded-lg",children:e.jsxs("div",{className:"flex items-center space-x-2 text-sm",children:[e.jsx(U,{className:"w-4 h-4"}),e.jsxs("span",{children:["현재"," ",e.jsxs("span",{className:"font-medium text-primary",children:[Q,"개 카테고리"]}),"의 알림을 받고 있습니다"]})]})})]})]}),e.jsx("div",{className:"bg-background/95 backdrop-blur-xl border-t border-border p-4 safe-nav-bottom flex-shrink-0",children:e.jsx(A,{onClick:q,className:"w-full",children:"완료"})})]}):e.jsxs("div",{className:"w-full h-full bg-background text-foreground flex flex-col",children:[e.jsx(O,{title:"알림 설정",icon:e.jsx(L,{className:"w-5 h-5"}),onBack:u}),e.jsx("div",{className:"flex-1 flex items-center justify-center",children:e.jsx("span",{className:"text-sm text-muted-foreground",children:"알림 설정을 불러오는 중..."})})]})}export{oe as NotificationSettingsDialog};
