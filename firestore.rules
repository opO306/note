rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // âœ… ë¡œê·¸ì¸ ì²´í¬ í•¨ìˆ˜
    function isSignedIn() {
      return request.auth != null;
    }
    
    // âœ… ë³¸ì¸ í™•ì¸ í•¨ìˆ˜
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // 1. ì‚¬ìš©ì ì •ë³´ (users)
    match /users/{userId} {
      allow read: if isSignedIn();
      allow create, update: if isOwner(userId);
      
      match /{document=**} {
        allow read, write: if isOwner(userId);
      }
    }

    // 2. ê²Œì‹œê¸€ (posts)
    match /posts/{postId} {
      allow read: if true;
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && (
        resource.data.authorUid == request.auth.uid || 
        resource.data.uid == request.auth.uid
      );
    }

    // 3. íŒ”ë¡œìš° (follows)
    match /follows/{followId} {
      allow read: if isSignedIn();
      allow create, delete: if isSignedIn();
    }

    // 4. ë¶ë§ˆí¬ (user_bookmarks)
    match /user_bookmarks/{userId}/{document=**} {
      allow read, write: if isOwner(userId);
    }

    // 5. ì•Œë¦¼ (user_notifications)
 		match /user_notifications/{userId}/{document=**} {
      // Aì•ˆ: ì•Œë¦¼ì€ Cloud Functions(Admin SDK)ë§Œ ìƒì„±
      allow read, delete: if isOwner(userId);

      // ì½ìŒ ì²˜ë¦¬ë§Œ í—ˆìš© (í•„ë“œëª… read ê°€ì •)
      allow update: if isOwner(userId)
        && request.resource.data.diff(resource.data).changedKeys().hasOnly(['read']);

      // í´ë¼ì´ì–¸íŠ¸ ìƒì„± ê¸ˆì§€
      allow create: if false;
    }
    
    // 6. ì•Œë¦¼ ì„¤ì • (user_notification_settings)
    match /user_notification_settings/{userId} {
      allow read, write: if isOwner(userId);
    }

    // 7. ì¢‹ì•„ìš”/ë“±ë¶ˆ (user_lanterns)
    match /user_lanterns/{userId}/{document=**} {
      // Aì•ˆ: í† ê¸€ ê¸°ë¡ë§Œ í´ë¼ì´ì–¸íŠ¸ì—ì„œ í•˜ê³ , ì¹´ìš´í„°/í›„ì²˜ë¦¬ëŠ” Functionsì—ì„œ
      allow read: if isOwner(userId);
      allow create, delete: if isOwner(userId);
      allow update: if false;
    }

    // 8. ì‹ ê³  (reports)
    match /reports/{reportId} {
      allow create: if isSignedIn();
      allow read, update, delete: if false; 
    }

    // ğŸš¨ [ì¶”ê°€ë¨] 9. ì¡°íšŒìˆ˜ ê¸°ë¡ (postViews)
    // - ì¡°íšŒìˆ˜ ì¤‘ë³µ ë°©ì§€ë¥¼ ìœ„í•´ ë¡œê·¸ì¸í•œ ìœ ì €ëŠ” ê¸°ë¡ì„ ì½ê³  ì“¸ ìˆ˜ ìˆì–´ì•¼ í•¨
    match /postViews/{viewId} {
      allow read, write: if isSignedIn();
    }
    
    // 10. ì£¼ê°„ í†µê³„ (weekly_stats)
    // - ë¡œê·¸ì¸í•œ ëª¨ë“  ìœ ì €ê°€ ì½ì„ ìˆ˜ ìˆìŒ (ë­í‚¹ ê³µê°œ)
    // - ì“°ê¸°ëŠ” Cloud Functionsë§Œ ê°€ëŠ¥
    match /weekly_stats/{statsId} {
      allow read: if isSignedIn();
      allow write: if false;
    }
    
    // ê·¸ ì™¸ ì°¨ë‹¨
    match /{document=**} {
      allow read, write: if false;
    }
  }
}