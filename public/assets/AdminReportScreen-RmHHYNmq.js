import{r as l,j as e}from"./vendor-radix-common-Lw-R5L56.js";import{c as X,q as Z,l as ee,o as z,w as te,a as se,d as S,b as v,u as re,h as ae,f as ne,A as ie,B as A,C,e as T,g as I,i as U,j as R,k as le,m as G}from"./index-zqdvtYl2.js";import"./vendor-react-BjpLs-I5.js";import"./vendor-utils-NdZ4-hto.js";import"./vendor-radix-extra-SjO53O2I.js";import"./vendor-icons-B8UqI-Qt.js";function pe({onBack:H}){const[y,O]=l.useState([]),[N,D]=l.useState(null),[L]=l.useState(null),[V]=l.useState(null),[k,_]=l.useState(!1),[q,b]=l.useState(null),[c,Y]=l.useState(null),[u,p]=l.useState(null),[h,m]=l.useState(null),[B,x]=l.useState(""),[E,P]=l.useState(!1),[f,w]=l.useState(null),a=l.useMemo(()=>y.find(r=>r.id===N)??null,[y,N]);l.useEffect(()=>{const r=X(v,"reports"),n=Z(r,te("status","in",["pending","needs_review"]),z("priority","desc"),z("createdAt","desc"),ee(50)),i=se(n,d=>{const t=d.docs.map(o=>{const s=o.data();return{id:o.id,targetType:s.targetType==="reply"?"reply":"post",targetId:String(s.targetId??""),targetAuthorUid:typeof s.targetAuthorUid=="string"?s.targetAuthorUid:null,reporterUid:typeof s.reporterUid=="string"?s.reporterUid:null,reasons:Array.isArray(s.reasons)?s.reasons:[],details:typeof s.details=="string"&&s.details.length>0?s.details:null,createdAt:s.createdAt??null,status:s.status==="needs_review"||s.status==="confirmed"||s.status==="rejected"?s.status:"pending",priority:s.priority==="high"?"high":"normal",postId:typeof s.postId=="string"&&s.postId.length>0?s.postId:null}});O(t),D(o=>o&&!t.some(s=>s.id===o)?null:o)},d=>{console.error("[AdminReportScreen] reports 구독 에러:",d)});return()=>{i()}},[]),l.useEffect(()=>{let r=!1;return(async()=>{if(!a){if(r)return;p(null),m(null),x("");return}try{if(a.targetType==="post"){const i=S(v,"posts",a.targetId),d=await G(i);if(r)return;if(!d.exists()){p(null),m(null),x("");return}const t=d.data(),o=t.createdAt&&typeof t.createdAt.toDate=="function"?t.createdAt.toDate():new Date,s={id:d.id,title:t.title??"",content:t.content??"",category:t.category??"기타",subCategory:t.subCategory??"전체",type:t.type??"question",tags:Array.isArray(t.tags)?t.tags:[],author:t.author??"알 수 없음",authorUid:typeof t.authorUid=="string"?t.authorUid:null,authorAvatar:t.authorAvatar??"",createdAt:o,lanterns:typeof t.lanterns=="number"?t.lanterns:0,replies:Array.isArray(t.replies)?t.replies:[],replyCount:typeof t.replyCount=="number"?t.replyCount:Array.isArray(t.replies)?t.replies.length:0,comments:typeof t.comments=="number"?t.comments:Array.isArray(t.replies)?t.replies.length:0,views:typeof t.views=="number"?t.views:0,isBookmarked:!1,isOwner:!1,authorTitleId:t.authorTitleId??null,authorTitleName:t.authorTitleName??null,hidden:t.hidden===!0,reportCount:typeof t.reportCount=="number"?t.reportCount:void 0};if(r)return;p(s),m(null),x(s.author)}else{if(!a.postId){if(r)return;p(null),m(null),x("");return}const i=S(v,"posts",a.postId),d=await G(i);if(r)return;if(!d.exists()){p(null),m(null),x("");return}const t=d.data(),o=Array.isArray(t.replies)?t.replies:[],s=o.find(j=>String(j.id??"")===a.targetId)??null;if(r)return;const Q=t.createdAt&&typeof t.createdAt.toDate=="function"?t.createdAt.toDate():new Date,W={id:d.id,title:t.title??"",content:t.content??"",category:t.category??"기타",subCategory:t.subCategory??"전체",type:t.type??"question",tags:Array.isArray(t.tags)?t.tags:[],author:t.author??"알 수 없음",authorUid:typeof t.authorUid=="string"?t.authorUid:null,authorAvatar:t.authorAvatar??"",createdAt:Q,lanterns:typeof t.lanterns=="number"?t.lanterns:0,replies:o,replyCount:typeof t.replyCount=="number"?t.replyCount:o.length,comments:typeof t.comments=="number"?t.comments:o.length,views:typeof t.views=="number"?t.views:0,isBookmarked:!1,isOwner:!1,authorTitleId:t.authorTitleId??null,authorTitleName:t.authorTitleName??null,hidden:t.hidden===!0,reportCount:typeof t.reportCount=="number"?t.reportCount:void 0};if(r)return;if(p(W),!s){m(null),x("");return}let g;if(s.createdAt&&typeof s.createdAt.toDate=="function")g=s.createdAt.toDate();else if(s.createdAt instanceof Date)g=s.createdAt;else if(typeof s.createdAt=="string"||typeof s.createdAt=="number"){const j=new Date(s.createdAt);g=Number.isNaN(j.getTime())?new Date:j}else g=new Date;const M={id:typeof s.id=="number"||typeof s.id=="string"?s.id:a.targetId,content:s.content??"",author:s.author??"알 수 없음",authorUid:typeof s.authorUid=="string"?s.authorUid:null,authorAvatar:typeof s.authorAvatar=="string"?s.authorAvatar:"",timeAgo:s.timeAgo??"",lanterns:typeof s.lanterns=="number"?s.lanterns:0,isGuide:!!s.isGuide,createdAt:g,authorTitleId:s.authorTitleId??null};if(r)return;m(M),x(M.author)}}catch(i){if(r)return;console.error("[AdminReportScreen] 대상 로드 에러:",i),p(null),m(null),x("")}})(),()=>{r=!0}},[a]);const $=l.useCallback((r,n)=>{w({reportId:r,nextStatus:n})},[]),J=l.useCallback(async()=>{if(!f)return;const{reportId:r,nextStatus:n}=f;P(!0);try{const i=S(v,"reports",r);await re(i,{status:n})}catch(i){console.error("[AdminReportScreen] status 업데이트 실패:",i)}finally{P(!1),w(null)}},[f]),K=l.useCallback(async()=>{if(!a)return;const r=a.targetType==="post",n=r?u?.content??"":h?.content??"";if(!n){b("검수할 본문이 없습니다.");return}_(!0),b(null);try{const i=ae(ne,"aiModerationReview"),{data:d}=await i({targetType:a.targetType,title:r?u?.title??"":"",content:n,reasons:a.reasons,details:a.details,reporterUid:a.reporterUid??null,targetAuthorUid:a.targetAuthorUid??null});Y(d)}catch(i){console.error("[AdminReportScreen] AI 검수 실패:",i),b(i?.message??"AI 검수 요청에 실패했습니다.")}finally{_(!1)}},[a,u,h]),F=r=>{if(!r||typeof r.toDate!="function")return"";const n=r.toDate(),i=n.getFullYear(),d=String(n.getMonth()+1).padStart(2,"0"),t=String(n.getDate()).padStart(2,"0"),o=String(n.getHours()).padStart(2,"0"),s=String(n.getMinutes()).padStart(2,"0");return`${i}-${d}-${t} ${o}:${s}`};return e.jsxs("div",{className:"w-full flex-1 min-h-0 bg-background text-foreground flex flex-col",children:[e.jsx(ie,{title:"신고 관리",onBack:H}),e.jsxs("div",{className:"flex-1 min-h-0 flex flex-col md:flex-row border-t border-border",children:[e.jsx("div",{className:"flex-1 min-h-0 md:w-1/2 border-b md:border-b-0 md:border-r border-border overflow-y-auto",children:y.length===0?e.jsx("div",{className:"p-4 text-sm text-muted-foreground",children:"처리할 신고가 없습니다."}):y.map(r=>e.jsxs("button",{type:"button",onClick:()=>D(r.id),className:`w-full text-left px-4 py-3 border-b border-border hover:bg-accent/20 ${N===r.id?"bg-accent/30":"bg-background"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsxs("div",{className:"text-xs text-muted-foreground",children:[r.targetType==="post"?"게시글":"댓글"," 신고"]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[r.priority==="high"&&e.jsx(A,{variant:"destructive",className:"text-[10px]",children:"우선 검토"}),e.jsxs(A,{variant:r.status==="pending"?"outline":r.status==="needs_review"?"secondary":r.status==="confirmed"?"default":"outline",className:"text-[10px]",children:[r.status==="pending"&&"대기",r.status==="needs_review"&&"검토 필요",r.status==="confirmed"&&"확정",r.status==="rejected"&&"거절"]})]})]}),e.jsx("div",{className:"text-xs text-muted-foreground mb-1",children:F(r.createdAt)}),e.jsx("div",{className:"text-sm font-medium truncate",children:r.reasons&&r.reasons.length>0?r.reasons[0]:"사유 없음"}),r.details&&e.jsx("div",{className:"text-xs text-muted-foreground line-clamp-2 mt-1",children:r.details})]},r.id))}),e.jsx("div",{className:"flex-1 min-h-0 md:w-1/2 overflow-y-auto",children:a?e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs(C,{children:[e.jsx(T,{children:e.jsx(I,{className:"text-sm",children:"신고 정보"})}),e.jsxs(U,{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"대상"}),e.jsx("span",{children:a.targetType==="post"?"게시글":"댓글"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"신고 상태"}),e.jsx("span",{children:a.status})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"우선순위"}),e.jsx("span",{children:a.priority==="high"?"높음":"보통"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground mb-1",children:"신고 사유"}),e.jsx("ul",{className:"list-disc list-inside space-y-1",children:a.reasons&&a.reasons.length>0?a.reasons.map((r,n)=>e.jsx("li",{children:r},n)):e.jsx("li",{className:"text-muted-foreground",children:"사유가 없습니다."})})]}),a.details&&e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground mb-1",children:"상세 설명"}),e.jsx("div",{className:"whitespace-pre-wrap",children:a.details})]}),e.jsxs("div",{className:"text-xs text-muted-foreground mt-2",children:["생성일시: ",F(a.createdAt)]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"작성자 신뢰도"}),e.jsx("span",{children:L??"알 수 없음"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"신고자 신뢰도"}),e.jsx("span",{children:V??"알 수 없음"})]})]})]}),e.jsxs(C,{children:[e.jsx(T,{children:e.jsx(I,{className:"text-sm",children:"대상 콘텐츠"})}),e.jsxs(U,{className:"space-y-2 text-sm",children:[a.targetType==="post"&&u&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"font-semibold",children:u.title}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["작성자: ",B||u.author]}),e.jsx("div",{className:"mt-2 whitespace-pre-wrap",children:String(u.content??"")})]}),a.targetType==="reply"&&h&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"text-xs text-muted-foreground",children:["댓글 작성자:"," ",B||h.author]}),e.jsx("div",{className:"mt-2 whitespace-pre-wrap",children:String(h.content??"")}),u&&e.jsxs("div",{className:"mt-4 p-3 rounded-md bg-muted/40 text-xs",children:[e.jsx("div",{className:"font-semibold mb-1",children:"원문 게시글"}),e.jsx("div",{className:"text-xs text-muted-foreground",children:u.title})]})]}),!u&&!h&&e.jsx("div",{className:"text-xs text-muted-foreground",children:"대상 글/댓글을 찾을 수 없습니다. (이미 삭제되었을 수 있습니다)"})]})]}),e.jsxs(C,{children:[e.jsxs(T,{className:"flex flex-row items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(I,{className:"text-sm",children:"AI 검수 보조"}),e.jsx("div",{className:"text-xs text-muted-foreground mt-1",children:"운영자 전용 · Vertex AI Gemini 사용"})]}),e.jsx(R,{size:"sm",onClick:K,disabled:k||!a,children:k?"검수 중...":"AI 요약/권고"})]}),e.jsxs(U,{className:"space-y-3 text-sm",children:[q&&e.jsx("div",{className:"text-destructive text-xs",children:q}),c?e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground text-xs",children:"요약"}),e.jsx("div",{className:"mt-1 whitespace-pre-wrap",children:c.summary})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground text-xs",children:"권고"}),e.jsxs(A,{variant:c.recommendation==="reject"?"secondary":c.recommendation==="action_needed"?"destructive":"outline",children:[c.recommendation==="reject"&&"무효/거절 권고",c.recommendation==="needs_review"&&"추가 검토 필요",c.recommendation==="action_needed"&&"조치 필요"]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground text-xs",children:"위험 점수"}),e.jsxs("span",{children:[(c.riskScore*100).toFixed(0),"%"]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground text-xs",children:"근거"}),e.jsx("div",{className:"mt-1 whitespace-pre-wrap",children:c.rationale})]}),c.flags&&c.flags.length>0&&e.jsxs("div",{children:[e.jsx("div",{className:"text-muted-foreground text-xs",children:"감지 플래그"}),e.jsx("div",{className:"flex flex-wrap gap-2 mt-1",children:c.flags.map((r,n)=>e.jsx(A,{variant:"outline",children:r},n))})]})]}):e.jsx("div",{className:"text-muted-foreground text-xs",children:"신고된 본문을 바탕으로 요약과 조치 권고를 받아볼 수 있습니다."})]})]}),e.jsxs("div",{className:"flex items-center justify-end space-x-2",children:[e.jsx(R,{variant:"outline",size:"sm",disabled:E,onClick:()=>$(a.id,"rejected"),children:"문제 없음"}),e.jsx(R,{variant:"default",size:"sm",disabled:E,onClick:()=>$(a.id,"confirmed"),children:"문제 있음"})]})]}):e.jsx("div",{className:"p-4 text-sm text-muted-foreground",children:"왼쪽에서 신고를 선택하면 상세 내용이 표시됩니다."})})]}),e.jsx(le,{open:!!f,onOpenChange:r=>{r||w(null)},title:"신고 처리",description:f?.nextStatus==="confirmed"?"이 신고를 '문제 있음'으로 처리할까요? 해당 글(또는 댓글)은 사용자 화면에서 숨겨집니다.":"이 신고를 '문제 없음'으로 처리할까요?",confirmText:"확인",onConfirm:J})]})}export{pe as AdminReportScreen};
