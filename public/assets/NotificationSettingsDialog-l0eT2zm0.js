import{j as e,r}from"./vendor-radix-common-Lw-R5L56.js";import{A as Y,Q as C,d as U,b as D,u as L,t as x,m as Z,R as B,S as z,U as F,j as k}from"./index-zqdvtYl2.js";import{l as H,k as J}from"./vendor-icons-B8UqI-Qt.js";import"./vendor-react-BjpLs-I5.js";import"./vendor-utils-NdZ4-hto.js";import"./vendor-radix-extra-SjO53O2I.js";function M({title:o,icon:l,onBack:u,rightSlot:i,children:d}){return e.jsxs("div",{className:"w-full h-full bg-background text-foreground flex flex-col",children:[e.jsx(Y,{title:o,icon:l,onBack:u,rightSlot:i}),e.jsx("main",{className:"flex-1 min-h-0 overflow-y-auto scrollbar-hide",children:d})]})}const v={getItem:o=>{try{return typeof window>"u"?null:localStorage.getItem(o)}catch(l){return console.error("localStorage getItem error:",l),null}},setItem:(o,l)=>{try{if(typeof window>"u")return;localStorage.setItem(o,l)}catch(u){console.error("localStorage setItem error:",u)}}};function ie({onBack:o,categories:l}){const[u,i]=r.useState(new Set),[d,h]=r.useState(!0),[O,I]=r.useState(!1),w=r.useRef(null),R=r.useRef(null),p=r.useCallback((t,a,s)=>{const n=s??C.currentUser?.uid??"guest",f=Array.from(t);v.setItem(`notificationSettings:${n}`,JSON.stringify(f)),v.setItem(`allNotificationsEnabled:${n}`,a.toString())},[]),m=r.useCallback((t,a)=>{const s=C.currentUser?.uid??null;if(p(t,a,s),!s)return;const n=U(D,"users",s),f={allEnabled:a,enabledCategories:Array.from(t)};R.current=f,w.current&&window.clearTimeout(w.current),w.current=window.setTimeout(async()=>{const N=R.current;if(N)try{await L(n,{notificationSettings:N})}catch(g){console.error("알림 설정 Firestore 동기화 실패:",g),x.error("알림 설정을 저장하지 못했어요. 잠시 후 다시 시도해주세요.")}},400)},[p]);r.useEffect(()=>()=>{w.current&&window.clearTimeout(w.current)},[]),r.useEffect(()=>{const t=l.map(c=>c.id),a=C.currentUser?.uid??"guest";let s=new Set(t),n=!0;const f=v.getItem(`notificationSettings:${a}`),N=v.getItem(`allNotificationsEnabled:${a}`);if(f)try{const c=JSON.parse(f);Array.isArray(c)&&(s=new Set(c.filter(y=>t.includes(y))))}catch(c){console.error("notificationSettings 파싱 실패:",c)}N!==null&&(n=N==="true");const g=C.currentUser?.uid;if(!g){i(s),h(n),I(!0);return}let j=!1;const E=U(D,"users",g);return(async()=>{try{const c=await Z(E);if(c.exists()){const b=c.data().notificationSettings;if(b&&typeof b=="object"){const S=typeof b.allEnabled=="boolean"?b.allEnabled:n,A=(Array.isArray(b.enabledCategories)?b.enabledCategories:Array.from(s)).filter(X=>t.includes(X)),$=new Set(S?A.length>0?A:t:A);j||(i($),h(S),p($,S,g))}else{j||(i(s),h(n),p(s,n,g));const S={allEnabled:n,enabledCategories:Array.from(s)};await L(E,{notificationSettings:S})}}else{j||(i(s),h(n),p(s,n));const y={allEnabled:n,enabledCategories:Array.from(s)};await B(E,{notificationSettings:y},{merge:!0})}}catch(c){console.error("알림 설정 Firestore 로드 실패:",c),x.error("알림 설정을 불러오지 못했어요. 기본 설정을 사용합니다."),j||(i(s),h(n))}finally{j||I(!0)}})(),()=>{j=!0}},[l,p]);const T=r.useCallback(t=>{const a=new Set(u),s=a.has(t);s?a.delete(t):a.add(t),i(a),m(a,d);const n=l.find(f=>f.id===t)?.name;x.success(s?`${n} 알림이 비활성화되었습니다`:`${n} 알림이 활성화되었습니다`)},[u,l,d,m]),P=r.useCallback(t=>()=>{T(t)},[T]),Q=r.useCallback(t=>{if(h(t),t){const a=l.map(n=>n.id),s=new Set(a);i(s),m(s,!0),x.success("모든 알림이 활성화되었습니다")}else{const a=new Set;i(a),m(a,!1),x.success("모든 알림이 비활성화되었습니다")}},[l,m]),_=r.useCallback(()=>{const t=l.map(s=>s.id),a=new Set(t);i(a),m(a,d),x.success("모든 카테고리 알림이 활성화되었습니다")},[l,d,m]),q=r.useCallback(()=>{const t=new Set;i(t),m(t,d),x.success("모든 카테고리 알림이 비활성화되었습니다")},[d,m]),G=r.useCallback(()=>{o()},[o]),K=r.useCallback(t=>e.jsx(t,{className:"w-4 h-4"}),[]),V=r.useMemo(()=>l.filter(t=>t.id!=="전체"),[l]),W=r.useMemo(()=>u.size,[u]);return O?e.jsx(M,{title:"알림 설정",icon:e.jsx(H,{className:"w-5 h-5"}),onBack:o,children:e.jsxs("div",{className:"p-4 space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(J,{className:"w-4 h-4 text-primary"}),e.jsx("span",{className:"font-medium",children:"전체 알림"})]}),e.jsx(z,{checked:d,onCheckedChange:Q})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"모든 알림을 일괄적으로 켜거나 끌 수 있습니다"})]}),e.jsx(F,{}),d&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"font-medium",children:"카테고리별 알림"}),e.jsxs("div",{className:"space-x-2",children:[e.jsx(k,{variant:"outline",size:"sm",onClick:_,className:"touch-target px-3 text-xs",children:"전체 선택"}),e.jsx(k,{variant:"outline",size:"sm",onClick:q,className:"touch-target px-3 text-xs",children:"전체 해제"})]})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"관심 있는 카테고리만 선택하여 알림을 받을 수 있습니다"}),e.jsx("div",{className:"space-y-3",children:V.map(t=>e.jsxs("div",{className:"flex items-center justify-between p-3 border border-border rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[K(t.icon),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:t.name}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[t.count,"개 게시글"]})]})]}),e.jsx(z,{checked:u.has(t.id),onCheckedChange:P(t.id)})]},t.id))}),e.jsx("div",{className:"mt-4 p-3 bg-muted/50 rounded-lg",children:e.jsxs("div",{className:"flex items-center space-x-2 text-sm",children:[e.jsx(J,{className:"w-4 h-4"}),e.jsxs("span",{children:["현재"," ",e.jsxs("span",{className:"font-medium text-primary",children:[W,"개 카테고리"]}),"의 알림을 받고 있습니다"]})]})})]}),e.jsx(F,{}),e.jsx("div",{className:"pt-2",children:e.jsx(k,{onClick:G,className:"w-full",children:"완료"})})]})}):e.jsx(M,{title:"알림 설정",icon:e.jsx(H,{className:"w-5 h-5"}),onBack:o,children:e.jsx("div",{className:"w-full h-full flex items-center justify-center",children:e.jsx("span",{className:"text-sm text-muted-foreground",children:"알림 설정을 불러오는 중..."})})})}export{ie as NotificationSettingsDialog};
